
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Trouver la chanson ‚Äì Jouer le refrain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SDK Spotify Web Playback -->
  https://sdk.scdn.co/spotify-player.js</script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem; line-height: 1.5; }
    button { margin: .25rem .5rem .25rem 0; padding: .6rem 1rem; }
    .row { margin: .5rem 0; }
    .status { margin-top: 1rem; color: #333; }
    .small { font-size: .9rem; color: #555; }
    .checkbox { margin-left: .75rem; }
  </style>
</head>
<body>
  <h1>Trouver la chanson ‚Äì Jouer le refrain</h1>
  <p class="small">
    Connecte‚Äëtoi √† Spotify, initialise le lecteur web, puis clique sur un titre pour d√©marrer directement au d√©but du refrain.
    Active l‚Äôoption pour r√©p√©ter le refrain en boucle.
  </p>

  <div class="row">
    <button id="btnLogin">Connecter Spotify</button>
    <button id="btnInit">Initialiser le lecteur web</button>
    <button id="btnTransfer">Transf√©rer vers le navigateur</button>
    <label class="checkbox"><input type="checkbox" id="chkLoop" /> R√©p√©ter le refrain</label>
    <button id="btnStopLoop">Arr√™ter la r√©p√©tition</button>
    <button id="btnReset">R√©initialiser l‚Äôauth</button>
  </div>

  <div class="status" id="status">‚è≥ Non connect√©</div>
  <hr />

  <div id="tracks">
    <div class="row">
      <strong>Huey Lewis &amp; The News ‚Äî The Power of Love</strong>
      <button class="play" data-uri="spotify:track:0xYyF6WcAqkS3YDN1GJLEo" data-start="60000" data-end="90000">
        Jouer le refrain (1:00 ‚Üí 1:30)
      </button>
    </div>
    <div class="row">
      <strong>Bee Gees ‚Äî Stayin‚Äô Alive</strong>
      <button class="play" data-uri="spotify:track:4MvVAsHqOQp0v1Z2n3wN2N" data-start="45000" data-end="72000">
        Jouer le refrain (0:45 ‚Üí 1:12)
      </button>
    </div>
  </div>

  <script type="module">
    // -----------------------------
    // CONFIG
    // -----------------------------
    const CLIENT_ID = 'TON_CLIENT_ID_SPOTIFY'; // <<<<<< Remplace par ton Client ID
    const REDIRECT_URI = 'https://octetluc.github.io/trouverlachanson/'; // GitHub Pages
    const SCOPES = [
      'streaming',
      'user-read-playback-state',
      'user-modify-playback-state',
      'user-read-currently-playing'
    ]; // Scopes requis pour Web Playback SDK et Player API (lecture, seek, transfer)  [1](https://developer.spotify.com/documentation/web-api/concepts/scopes)

    // -----------------------------
    // UTIL PKCE
    // -----------------------------
    function base64urlencode(arrayBuffer) {
      return btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    async function sha256(str) {
      const data = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return base64urlencode(digest);
    }

    let codeVerifier = localStorage.getItem('spotify_code_verifier') || null;
    let accessToken = null;
    let player = null;
    let deviceId = null;

    const statusEl = document.getElementById('status');
    const chkLoop = document.getElementById('chkLoop');

    const loopState = { enabled: false, start: 0, end: 0, interval: null };

    // -----------------------------
    // AUTH: d√©marrer l‚Äôautorisation (PKCE)
    // -----------------------------
    async function startLogin() {
      // G√©n√®re un code verifier
      codeVerifier = [...crypto.getRandomValues(new Uint8Array(64))]
        .map(b => ('0' + (b & 0xff).toString(16)).slice(-2)).join('');
      localStorage.setItem('spotify_code_verifier', codeVerifier);

      const codeChallenge = await sha256(codeVerifier);
      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        response_type: 'code',
        redirect_uri: REDIRECT_URI,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge,
        scope: SCOPES.join(' ')
      });

      // Redirection vers Spotify Accounts
      window.location = `https://accounts.spotify.com/authorize?${params.toString()}`;  [2](https://developer.spotify.com/documentation/web-api/concepts/authorization)
    }

    // √âchange code -> token
    async function handleCallbackAndGetToken() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      if (!code) return;

      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: 'authorization_code',
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: codeVerifier
      });

      const res = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      if (!res.ok) {
        statusEl.textContent = '‚ùå √âchec de l‚Äôobtention du token.';
        return;
      }
      const data = await res.json();
      accessToken = data.access_token;
      // Nettoie le param√®tre ?code= dans l‚ÄôURL
      history.replaceState({}, document.title, REDIRECT_URI);
      statusEl.textContent = '‚úÖ Connect√© √† Spotify';
    }

    // -----------------------------
    // WEB PLAYBACK SDK
    // -----------------------------
    window.onSpotifyWebPlaybackSDKReady = () => {
      // Le SDK est charg√©, l'init se fait via btnInit (√©vite l'init auto sans token)
    };

    async function initWebPlayer() {
      if (!accessToken) {
        statusEl.textContent = 'üôÉ Connecte-toi d‚Äôabord √† Spotify.';
        return;
      }

      player = new Spotify.Player({
        name: 'Lecteur Web ‚Äì Jeu du refrain',
        getOAuthToken: cb => cb(accessToken),
        volume: 0.8
      });

      // √âcouteurs d‚Äô√©tat/erreurs
      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        statusEl.textContent = `üéß Lecteur pr√™t (device_id: ${device_id})`;
      });

      player.addListener('not_ready', ({ device_id }) => {
        statusEl.textContent = `‚ö†Ô∏è Lecteur non pr√™t (device_id: ${device_id})`;
      });

      player.addListener('initialization_error', ({ message }) => {
        console.error('initialization_error', message);
        statusEl.textContent = `‚ùå Init error: ${message}`;
      });
      player.addListener('authentication_error', ({ message }) => {
        console.error('authentication_error', message);
        statusEl.textContent = `‚ùå Auth error: ${message}`;
      });
      player.addListener('account_error', ({ message }) => {
        console.error('account_error', message);
        statusEl.textContent = `‚ùå Account error: ${message}`;
      });

      const ok = await player.connect();
      statusEl.textContent = ok
        ? '‚úÖ Web Playback SDK connect√© √† Spotify'
        : '‚ùå √âchec de connexion au Web Playback SDK';
    }

    // Active l‚Äô√©l√©ment audio si l‚Äôautoplay est bloqu√© (utile iOS/Chrome)  [3](https://developer.spotify.com/documentation/web-playback-sdk)
    async function activateForAutoplay() {
      if (player && player.activateElement) {
        await player.activateElement();
      }
    }

    // -----------------------------
    // TRANSFERT VERS LE NAVIGATEUR
    // -----------------------------
    async function transferToWebDevice() {
      if (!accessToken || !deviceId) {
        statusEl.textContent = 'üôÉ Initialise le lecteur web avant le transfert.';
        return;
      }
      await activateForAutoplay();

      const res = await fetch('https://api.spotify.com/v1/me/player', {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ device_ids: [deviceId], play: true })
      });

      statusEl.textContent = (res.status === 204)
        ? 'üîÅ Lecture transf√©r√©e vers le navigateur'
        : `‚ö†Ô∏è Transfert: ${res.status}`;
    }  <!-- [4](https://developer.spotify.com/documentation/web-api/reference/transfer-a-users-playback) -->

    // -----------------------------
    // LECTURE D‚ÄôUN SEGMENT (start_ms ‚Üí end_ms) + BOUCLE
    // -----------------------------
    async function playSegment(trackUri, startMs, endMs) {
      if (!accessToken || !deviceId) {
        statusEl.textContent = 'üôÉ Initialise et transf√®re vers le navigateur avant de jouer.';
        return;
      }

      // D√©marre la piste directement √† start_ms (position_ms en snake_case)
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${encodeURIComponent(deviceId)}`, {
        method: 'PUT',
        headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ uris: [trackUri], position_ms: startMs })
      });  <!-- [5](https://developer.spotify.com/documentation/web-api/reference/seek-to-position-in-currently-playing-track) -->

      // Configure la boucle
      clearInterval(loopState.interval);
      loopState.start = startMs;
      loopState.end = endMs;
      loopState.enabled = chkLoop.checked;

      const tick = async () => {
        const state = await player.getCurrentState();
        if (!state || typeof state.position !== 'number') return;

        const pos = state.position;
        if (loopState.enabled && pos >= loopState.end) {
          // Seek au d√©but du segment
          await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${loopState.start}&device_id=${encodeURIComponent(deviceId)}`, {
            method: 'PUT',
            headers: { Authorization: `Bearer ${accessToken}` }
          });  <!-- [5](https://developer.spotify.com/documentation/web-api/reference/seek-to-position-in-currently-playing-track) -->
        }
      };

      loopState.interval = setInterval(tick, 100);
      statusEl.textContent = `‚ñ∂Ô∏è Segment ${msToClock(startMs)} ‚Üí ${msToClock(endMs)} (boucle ${loopState.enabled ? 'ON' : 'OFF'})`;
    }

    function msToClock(ms) {
      const s = Math.floor(ms / 1000);
      return `${String(Math.floor(s / 60)).padStart(1, '0')}:${String(s % 60).padStart(2, '0')}`;
    }

    function stopLoop() {
      loopState.enabled = false;
      chkLoop.checked = false;
      clearInterval(loopState.interval);
      statusEl.textContent = '‚õî R√©p√©tition arr√™t√©e';
    }

    // -----------------------------
    // RESET AUTH (force une r√©auth propre)
    // -----------------------------
    function resetAuth() {
      localStorage.removeItem('spotify_code_verifier');
      location.href = REDIRECT_URI;
    }

    // -----------------------------
    // WIRING UI
    // -----------------------------
    document.getElementById('btnLogin').addEventListener('click', startLogin);
    document.getElementById('btnInit').addEventListener('click', initWebPlayer);
    document.getElementById('btnTransfer').addEventListener('click', transferToWebDevice);
    document.getElementById('btnStopLoop').addEventListener('click', stopLoop);
    document.getElementById('btnReset').addEventListener('click', resetAuth);
    chkLoop.addEventListener('change', () => { loopState.enabled = chkLoop.checked; });

    document.querySelectorAll('button.play').forEach(btn => {
      btn.addEventListener('click', async () => {
        const uri = btn.dataset.uri;
        const start = parseInt(btn.dataset.start, 10);
        const end = parseInt(btn.dataset.end, 10);
        await playSegment(uri, start, end);
      });
    });

    // Si retour OAuth (code dans l‚ÄôURL), on √©change -> token
    handleCallbackAndGetToken();
  </script>

  <!--
    Notes techniques :
    - Le Web Playback SDK n√©cessite le scope "streaming" et un compte Premium.  [3](https://developer.spotify.com/documentation/web-playback-sdk)
    - Transf√©rer la lecture vers le device web : PUT /v1/me/player avec device_ids + play.  [4](https://developer.spotify.com/documentation/web-api/reference/transfer-a-users-playback)
    - D√©marrer √† un timestamp pr√©cis : PUT /v1/me/player/play avec position_ms ; boucler via PUT /v1/me/player/seek.  [5](https://developer.spotify.com/documentation/web-api/reference/seek-to-position-in-currently-playing-track)
    - Authorization Code avec PKCE recommand√© pour apps web c√¥t√© navigateur.  [2](https://developer.spotify.com/documentation/web-api/concepts/authorization)
  -->
</body>
</html>
