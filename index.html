
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trouver la chanson — Lecteur Spotify (timestamp)</title>
  <style>
    :root{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif}
    body{margin:24px;}
    h1{font-size:1.4rem;margin:0 0 12px 0}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input[type=text]{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:1rem}
    input[type=number]{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:1rem}
    button{appearance:none;border:0;background:#1DB954;color:white;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer}
    button.secondary{background:#444}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > div{flex:1 1 280px}
    .muted{color:#666}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ddd;padding:12px;border-radius:8px}
    footer{margin-top:24px;color:#666}
    .warn{background:#fff6e0;border:1px solid #ffe08a;padding:8px;border-radius:8px;margin-top:8px}
  </style>
</head>
<body>
  <h1>Trouver la chanson — Lecteur Spotify (à partir d'un timestamp)</h1>

  <div class="card">
    <p>
      <strong>Étapes rapides :</strong>
      <ol>
        <li>Cliquer « Se connecter à Spotify » (Spotify Premium requis).</li>
        <li>Saisir l'URI <code>spotify:track:…</code> <em>ou</em> l'URL <em>open.spotify.com/track/…</em>.</li>
        <li>Entrer le temps de départ (<code>mm:ss</code>, <code>hh:mm:ss</code> ou <code>secondes</code>).</li>
        <li>Cliquer « Jouer à partir du timestamp ».</li>
      </ol>
    </p>
    <div class="warn">
      ⚠️ Sur iOS, Safari exige une interaction utilisateur : démarrez la lecture via le bouton ci‑dessous si elle ne démarre pas automatiquement.
    </div>
  </div>

  <div class="card" id="auth">
    <div class="row">
      <div>
        <button id="loginBtn">Se connecter à Spotify</button>
        <button id="logoutBtn" class="secondary" title="Effacer la session">Déconnexion</button>
      </div>
      <div>
        <div id="authState" class="muted">Non connecté</div>
      </div>
    </div>
  </div>

  <div class="card">
    <label for="trackInput">Piste Spotify (URI <code>spotify:track:…</code> ou URL)</label>
    <input id="trackInput" type="text" placeholder="Ex.: spotify:track:6rqhFgbbKwnb9MLmUQDhG6 ou https://open.spotify.com/track/6rqhFgbbKwnb9MLmUQDhG6" />

    <label for="tsInput">Timestamp de départ</label>
    <input id="tsInput" type="text" placeholder="Ex.: 1:23 ou 00:01:23 ou 83" />

    <div style="margin-top:12px" class="row">
      <div><button id="playBtn">Jouer à partir du timestamp</button></div>
      <div><button id="pauseBtn" class="secondary">Pause</button> <button id="resumeBtn" class="secondary">Reprendre</button></div>
    </div>
  </div>

  <div class="card">
    <strong>État</strong>
    <div id="status" class="muted">Lecteur non initialisé</div>
    <div id="log" style="margin-top:8px"></div>
  </div>

  <footer>
    <small>Construit avec Spotify Web Playback SDK et l'API Web. Utilisation non commerciale uniquement.</small>
  </footer>

  <!-- SDK du lecteur Spotify -->
  <script/sdk.scdn.co/spotify-player.js</script>
  ``

      
  <script>
    // === Paramètres Spotify ===
    const CLIENT_ID = '1d3b46cc1be34f21a8922d6181460d45';
    const REDIRECT_URI = 'https://octetsluc.github.io/trouverlachanson/';
    const SCOPES = [
      'streaming',
      'user-read-email',
      'user-read-private',
      'user-modify-playback-state',
    ];

    // === Utilitaires ===
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { const el = $('log'); el.textContent += `${msg}\n`; el.scrollTop = el.scrollHeight; };
    const setStatus = (msg) => $('status').textContent = msg;

    // Parse un timestamp "mm:ss", "hh:mm:ss" ou secondes en millisecondes
    function parseTimestampToMs(input) {
      if (!input) return 0;
      const s = String(input).trim();
      if (/^\d+$/.test(s)) { // secondes
        return parseInt(s, 10) * 1000;
      }
      const parts = s.split(':').map(x => parseInt(x, 10));
      if (parts.some(isNaN)) return 0;
      let secs = 0;
      if (parts.length === 2) { // mm:ss
        secs = parts[0] * 60 + parts[1];
      } else if (parts.length === 3) { // hh:mm:ss
        secs = parts[0] * 3600 + parts[1] * 60 + parts[2];
      } else { return 0; }
      return secs * 1000;
    }

    // Convertit une URL open.spotify.com/track/... en URI spotify:track:...
    function normalizeTrack(input) {
      const val = String(input || '').trim();
      if (!val) return null;
      if (val.startsWith('spotify:track:')) return val;
      try {
        const u = new URL(val);
        if (u.hostname.includes('open.spotify.com')) {
          const segs = u.pathname.split('/').filter(Boolean);
          if (segs[0] === 'track' && segs[1]) {
            return `spotify:track:${segs[1]}`; // ignore query
          }
        }
      } catch (_) {}
      return null;
    }

    // === PKCE helpers ===
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const values = crypto.getRandomValues(new Uint8Array(length));
      return values.reduce((acc, x) => acc + possible[x % possible.length], '');
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return await window.crypto.subtle.digest('SHA-256', data);
    }

    function base64urlencode(input) {
      return btoa(String.fromCharCode(...new Uint8Array(input)))
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
    }

    async function beginAuth() {
      const codeVerifier = generateRandomString(64);
      const hashed = await sha256(codeVerifier);
      const codeChallenge = base64urlencode(hashed);
      window.localStorage.setItem('code_verifier', codeVerifier);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        scope: SCOPES.join(' '),
        redirect_uri: REDIRECT_URI,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge,
      });
      window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    async function exchangeToken(code) {
      const codeVerifier = window.localStorage.getItem('code_verifier');
      const payload = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: REDIRECT_URI,
        code_verifier: codeVerifier,
      });
      const resp = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload,
      });
      const data = await resp.json();
      if (data.access_token) {
        window.localStorage.setItem('access_token', data.access_token);
        window.localStorage.setItem('refresh_token', data.refresh_token || '');
        window.localStorage.setItem('expires_at', String(Date.now() + (data.expires_in * 1000)));
        $('authState').textContent = 'Connecté (token valide)';
        log('Token obtenu.');
      } else {
        log('Échec de l\'échange du token: ' + JSON.stringify(data));
      }
    }

    async function refreshAccessToken() {
      const refresh = window.localStorage.getItem('refresh_token');
      if (!refresh) return; // pas de refresh token
      const payload = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: 'refresh_token',
        refresh_token: refresh,
      });
      const resp = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload,
      });
      const data = await resp.json();
      if (data.access_token) {
        window.localStorage.setItem('access_token', data.access_token);
        window.localStorage.setItem('expires_at', String(Date.now() + (data.expires_in * 1000)));
        log('Token rafraîchi.');
      } else {
        log('Échec du rafraîchissement du token: ' + JSON.stringify(data));
      }
    }

    function getAccessToken() {
      const token = window.localStorage.getItem('access_token');
      const expiresAt = parseInt(window.localStorage.getItem('expires_at') || '0', 10);
      if (!token) return null;
      if (Date.now() > expiresAt - 5000) { // refresh 5s avant l'expiration
        refreshAccessToken();
      }
      return window.localStorage.getItem('access_token');
    }

    function logout() {
      window.localStorage.removeItem('access_token');
      window.localStorage.removeItem('refresh_token');
      window.localStorage.removeItem('expires_at');
      window.localStorage.removeItem('code_verifier');
      $('authState').textContent = 'Non connecté';
      log('Session effacée.');
    }

    // === Web Playback SDK ===
    let player = null;
    let deviceId = null;

    window.onSpotifyWebPlaybackSDKReady = () => {
      setStatus('Initialisation du lecteur…');
      player = new Spotify.Player({
        name: 'Lecteur Web — Trouver la chanson',
        getOAuthToken: cb => {
          const token = getAccessToken();
          if (!token) {
            log('Aucun token actif — connectez-vous.');
            $('authState').textContent = 'Non connecté';
            return;
          }
          cb(token);
        },
        volume: 0.8,
      });

      // Événements
      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        setStatus(`Lecteur prêt (device_id: ${deviceId})`);
        log('Lecteur prêt. device_id=' + deviceId);
      });

      player.addListener('not_ready', ({ device_id }) => {
        setStatus(`Lecteur non prêt (${device_id})`);
      });

      player.addListener('initialization_error', ({ message }) => {
        log('Erreur init: ' + message);
      });
      player.addListener('authentication_error', ({ message }) => {
        log('Erreur auth: ' + message);
      });
      player.addListener('account_error', ({ message }) => {
        log('Erreur compte: ' + message);
      });

      player.connect().then(success => {
        if (success) {
          setStatus('Le SDK est connecté à Spotify.');
        } else {
          setStatus('Échec de connexion au SDK.');
        }
      });
    };

    async function ensureTransferToWebPlayer() {
      if (!deviceId) { log('Device ID absent — le lecteur n\'est pas prêt.'); return; }
      const token = getAccessToken();
      const resp = await fetch('https://api.spotify.com/v1/me/player', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ device_ids: [deviceId], play: true }),
      });
      if (resp.status === 204) {
        log('Transfert de la lecture vers le lecteur web réussi.');
      } else {
        log('Transfert de lecture — statut ' + resp.status);
      }
    }

    async function playFromTimestamp() {
      const uri = normalizeTrack($('trackInput').value);
      const positionMs = parseTimestampToMs($('tsInput').value);
      if (!uri) { log('Veuillez fournir une URI/URL de piste valide.'); return; }
      if (!deviceId) { log('Le lecteur n\'est pas prêt (device_id manquant).'); return; }
      const token = getAccessToken();
      if (!token) { log('Token manquant. Connectez-vous.'); return; }

      await ensureTransferToWebPlayer();

      // Démarre la lecture de la piste sur notre device avec position_ms
      const resp = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${encodeURIComponent(deviceId)}` , {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ uris: [uri], position_ms: positionMs }),
      });
      if (resp.status === 204) {
        setStatus('Lecture démarrée.');
        log(`Lecture de ${uri} à ${positionMs} ms`);
      } else if (resp.status === 403) {
        log('Erreur 403 — compte non Premium ou restriction du périphérique.');
      } else {
        const txt = await resp.text();
        log('Échec du démarrage de la lecture: HTTP ' + resp.status + ' ' + txt);
      }
    }

    async function pausePlayback() {
      const token = getAccessToken();
      const resp = await fetch('https://api.spotify.com/v1/me/player/pause', {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}` },
      });
      log('Pause — statut ' + resp.status);
    }

    async function resumePlayback() {
      const token = getAccessToken();
      const resp = await fetch('https://api.spotify.com/v1/me/player/play', {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}` },
      });
      log('Reprise — statut ' + resp.status);
    }

    // === Wiring UI ===
    $('loginBtn').addEventListener('click', beginAuth);
    $('logoutBtn').addEventListener('click', logout);
    $('playBtn').addEventListener('click', playFromTimestamp);
    $('pauseBtn').addEventListener('click', pausePlayback);
    $('resumeBtn').addEventListener('click', resumePlayback);

    // === Au chargement : gérer le callback OAuth ===
    (function init() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');
      if (error) { log('Erreur OAuth: ' + error); }
      if (code) {
        exchangeToken(code).then(() => {
          // Nettoyer l'URL
          const url = new URL(window.location);
          url.search = '';
          history.replaceState({}, document.title, url.toString());
        });
      } else {
        const token = getAccessToken();
        if (token) {
          $('authState').textContent = 'Connecté (session existante)';
        }
      }
    })();
  </script>
</body>
</html>
