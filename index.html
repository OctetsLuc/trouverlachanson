<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trouver la chanson – Jouer le refrain</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; }
button { padding: .8rem 1rem; margin: .5rem 0; font-size: 1rem; cursor: pointer; }
.track { margin: 1rem 0; }
#status { margin-top: 1rem; color: #0b6; }
#error { margin-top: .5rem; color: #c00; white-space: pre-wrap; }
.container { max-width: 900px; margin: auto; }
header { margin-bottom: 1rem; }
label { margin-left: 1rem; }
</style>
</head>
<body>
<div class="container">
<header>
  <h1>Trouver la chanson – Jouer le refrain</h1>
  <p>Connecte-toi à Spotify, initialise le lecteur web, puis clique sur un titre pour démarrer directement au début du refrain. Active l’option pour répéter le refrain en boucle.</p>
</header>

<!-- Contrôles -->
<button id="btnAuth">Connecter Spotify</button>
<button id="btnInit">Initialiser le lecteur web</button>
<button id="btnTransfer">Transférer vers le navigateur</button>
<label><input type="checkbox" id="chkRepeat" /> Répéter le refrain</label>
<button id="btnStopLoop">Arrêter la répétition</button>

<div id="status"></div>
<div id="error"></div>

<hr />

<!-- Exemples de chansons -->
<div class="track">
  <strong>Huey Lewis &amp; The News — The Power of Love</strong>
  <button class="play-refrain"
    data-uri="spotify:track:0aU29D6g6dR1s6QdWQKcYb"
    data-ms="60000"
    data-end-ms="90000">Jouer le refrain (1:00 → 1:30)</button>
</div>

<div class="track">
  <strong>Bee Gees — Stayin’ Alive</strong>
  <button class="play-refrain"
    data-uri="spotify:track:0e3FtJfGJY5JrZ3HcTnK2P"
    data-ms="45000"
    data-end-ms="72000">Jouer le refrain (0:45 → 1:12)</button>
</div>

<!-- Callback défini AVANT le SDK -->
<script>
  window.onSpotifyWebPlaybackSDKReady = function(){
    window._sdkReady = true;
    console.log('SDK Spotify prêt');
  };
</script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
// ====== CONFIG ======
const CLIENT_ID = '1d3b46cc1be34f21a8922d6181460d45';
const REDIRECT_URI = 'https://octetsluc.github.io/trouverlachanson/';
const SCOPES = [
  'streaming',
  'user-modify-playback-state',
  'user-read-private'
];

// ====== STATE ======
let accessToken = null, deviceId = null, player = null;
let loopTimer = null, loopActive = false;

// ====== PKCE helpers ======
async function pkceChallengeFromVerifier(v) {
  const data = new TextEncoder().encode(v);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function randomString(len=64){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}

// ====== OAuth: authorize ======
document.getElementById('btnAuth').onclick = async () => {
  const verifier = randomString(64);
  const challenge = await pkceChallengeFromVerifier(verifier);
  sessionStorage.setItem('verifier', verifier);
  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    response_type: 'code',
    redirect_uri: REDIRECT_URI,
    code_challenge_method: 'S256',
    code_challenge: challenge,
    scope: SCOPES.join(' ')
  });
  const url = 'https://accounts.spotify.com/authorize?' + params.toString();
  console.log('Authorize URL =', url);
  location.href = url;
};

// ====== Handle callback (racine /trouverlachanson/) ======
(async function handleCallback(){
  const params = new URLSearchParams(location.search);
  const hasCode = params.has('code');
  const onRoot = location.pathname.endsWith('/trouverlachanson/') || location.pathname.endsWith('/trouverlachanson');

  if (hasCode && onRoot) {
    const code = params.get('code');
    const verifier = sessionStorage.getItem('verifier');
    if (!code || !verifier) { document.getElementById('error').textContent = "Code/verifier manquants."; return; }

    const body = new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    });
    const res = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body
    });
    const json = await res.json();
    console.log('Token scopes =', json.scope);
    console.log('Token type =', json.token_type, 'expires_in =', json.expires_in);
    if (json.error) { document.getElementById('error').textContent = 'Token error: ' + JSON.stringify(json); return; }
    accessToken = json.access_token;
    document.getElementById('status').textContent = 'Connecté à Spotify.';
    history.replaceState({}, '', '/trouverlachanson/');
  }
})();

// ====== Web Playback SDK : initialisation robuste ======
function initPlayer() {
  if (!accessToken) {
    document.getElementById('error').textContent = "Authentifie-toi d'abord.";
    return;
  }
  try {
    if (window.Spotify && typeof window.Spotify.Player === 'function') {
      player = new Spotify.Player({
        name: 'Lecteur Web (GitHub Pages)',
        getOAuthToken: cb => cb(accessToken),
        volume: 0.8
      });

      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        document.getElementById('status').textContent = 'Lecteur prêt.';
      });

      player.addListener('initialization_error', ({ message }) => {
        document.getElementById('error').textContent = 'Init error: ' + message;
      });
      player.addListener('authentication_error', ({ message }) => {
        document.getElementById('error').textContent = 'Auth error: ' + message;
      });
      player.addListener('account_error', ({ message }) => {
        document.getElementById('error').textContent = 'Account error: ' + message;
      });

      player.connect();
    } else {
      document.getElementById('error').textContent =
        'SDK Spotify non chargé. Réessaie (Ctrl+F5) ou vérifie le script https://sdk.scdn.co/spotify-player.js.';
    }
  } catch (e) {
    document.getElementById('error').textContent = 'Exception init: ' + (e && e.message ? e.message : e);
  }
}

document.getElementById('btnInit').onclick = () => {
  if (window._sdkReady || (window.Spotify && typeof window.Spotify.Player === 'function')) {
    initPlayer();
    return;
  }
  window.onSpotifyWebPlaybackSDKReady = function(){
    window._sdkReady = true;
    initPlayer();
  };
};

// ====== Transfer playback ======
document.getElementById('btnTransfer').onclick = async () => {
  if (!accessToken || !deviceId) { document.getElementById('error').textContent = "Initialise le lecteur web d'abord."; return; }
  const res = await fetch('https://api.spotify.com/v1/me/player', {
    method: 'PUT', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ device_ids: [deviceId], play: false })
  });
  if (res.status === 204) { document.getElementById('status').textContent = 'Lecture transférée vers le navigateur.'; }
};

// ====== Loop helpers ======
function stopLoop(){ loopActive=false; if(loopTimer){ clearTimeout(loopTimer); loopTimer=null; } document.getElementById('status').textContent='Répétition arrêtée.'; }
document.getElementById('btnStopLoop').onclick = stopLoop;

async function seekTo(ms){
  const res = await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${ms}`, { method: 'PUT', headers: { Authorization: `Bearer ${accessToken}` } });
  if (res.status !== 204) { const txt = await res.text(); document.getElementById('error').textContent = 'Erreur seek: ' + txt; }
}
function scheduleLoop(startMs,endMs){ if(!loopActive) return; const FUDGE=250; const duration=Math.max(300,(endMs-startMs)-FUDGE); loopTimer=setTimeout(async()=>{ if(!loopActive) return; await seekTo(startMs); scheduleLoop(startMs,endMs); }, duration); }

async function playRefrainLoop(uri,startMs,endMs){
  stopLoop();
  const res = await fetch('https://api.spotify.com/v1/me/player/play', {
    method: 'PUT', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ uris: [uri], position_ms: startMs })
  });
  if (res.status !== 204) { const txt = await res.text(); document.getElementById('error').textContent = 'Erreur play: ' + txt; return; }
  loopActive = document.getElementById('chkRepeat').checked; if (loopActive){ scheduleLoop(startMs,endMs); document.getElementById('status').textContent='Lecture + répétition activée.'; }
}

document.querySelectorAll('.play-refrain').forEach(btn => {
  btn.addEventListener('click', () => { const uri=btn.dataset.uri; const startMs=parseInt(btn.dataset.ms,10); const endMs=parseInt(btn.dataset.endMs,10); playRefrainLoop(uri,startMs,endMs); });
});
</script>
</div>
</body>
</html>
